/**
 * Syrup Dilution API Route
 * 
 * API endpoint for dilution ratio calculations, dilution guides,\n * and concentration-based mixing instructions for commercial syrups.\n * \n * @example\n * ```typescript\n * // Get dilution guide for a syrup\n * GET /api/syrups/dilution?syrupId=torani-vanilla&batchSize=1L\n * \n * // Get dilution recommendations\n * GET /api/syrups/dilution/recommendations?useCase=coffee&syrupType=concentrate\n * \n * // Calculate specific dilution\n * POST /api/syrups/dilution/calculate\n * ```\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { DilutionGuide, PremadeSyrup } from '@/lib/types';\nimport { DilutionGuideService } from '@/lib/dilution-guides';\nimport { PremadeSyrupService } from '@/lib/premade-syrups';\nimport { syrupDatabase } from '@/data/syrups';\n\n/**\n * Initialize services (singleton pattern)\n */\nlet dilutionService: DilutionGuideService | null = null;\nlet syrupService: PremadeSyrupService | null = null;\n\nfunction getDilutionService(): DilutionGuideService {\n  if (!dilutionService) {\n    dilutionService = new DilutionGuideService();\n  }\n  return dilutionService;\n}\n\nfunction getSyrupService(): PremadeSyrupService {\n  if (!syrupService) {\n    syrupService = new PremadeSyrupService();\n    // Override with comprehensive database\n    (syrupService as any).syrups = syrupDatabase;\n  }\n  return syrupService;\n}\n\n/**\n * GET /api/syrups/dilution - Get dilution guide for a syrup\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const syrupId = searchParams.get('syrupId');\n    const batchSize = searchParams.get('batchSize') || '1L';\n    const targetStrength = searchParams.get('targetStrength') as any;\n    \n    if (!syrupId) {\n      return NextResponse.json(\n        { success: false, error: 'syrupId parameter is required' },\n        { status: 400 }\n      );\n    }\n    \n    const service = getDilutionService();\n    const syrupService = getSyrupService();\n    \n    // Find the syrup\n    const syrup = syrupService.getSyrupById(syrupId);\n    if (!syrup) {\n      return NextResponse.json(\n        { success: false, error: `Syrup not found: ${syrupId}` },\n        { status: 404 }\n      );\n    }\n    \n    // Get dilution guide\n    const dilutionGuide = service.getDilutionGuide(syrup, batchSize, targetStrength);\n    \n    // Get dilution recommendations for different use cases\n    const recommendations = {\n      coffee: service.getDilutionRecommendations(syrup, 'coffee'),\n      soda: service.getDilutionRecommendations(syrup, 'soda'),\n      dessert: service.getDilutionRecommendations(syrup, 'dessert'),\n      beverage: service.getDilutionRecommendations(syrup, 'beverage'),\n      cocktail: service.getDilutionRecommendations(syrup, 'cocktail')\n    };\n    \n    // Get carbonation guide\n    const carbonationGuide = service.getCarbonationGuide(syrup, batchSize);\n    \n    // Get nutritional information estimate\n    const nutritionalInfo = service.calculateNutritionalInfo(syrup, syrup.dilutionRatio, 250); // 250ml serving\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        syrup: {\n          id: syrup.id,\n          name: syrup.name,\n          brand: syrup.brand,\n          concentration: syrup.concentration,\n          dilutionRatio: syrup.dilutionRatio\n        },\n        dilutionGuide,\n        recommendations,\n        carbonationGuide,\n        nutritionalInfo,\n        batchSize,\n        targetStrength\n      }\n    });\n    \n  } catch (error) {\n    console.error('Error getting dilution guide:', error);\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Failed to get dilution guide',\n        message: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST /api/syrups/dilution/calculate - Calculate custom dilution\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { syrupId, targetVolume, desiredRatio, useCase } = body;\n    \n    if (!syrupId || !targetVolume || !desiredRatio) {\n      return NextResponse.json(\n        { \n          success: false, \n          error: 'Missing required parameters: syrupId, targetVolume, desiredRatio' \n        },\n        { status: 400 }\n      );\n    }\n    \n    const service = getDilutionService();\n    const syrupService = getSyrupService();\n    \n    // Find the syrup\n    const syrup = syrupService.getSyrupById(syrupId);\n    if (!syrup) {\n      return NextResponse.json(\n        { success: false, error: `Syrup not found: ${syrupId}` },\n        { status: 404 }\n      );\n    }\n    \n    // Parse target volume\n    const volume = parseVolume(targetVolume);\n    if (!volume) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid target volume format' },\n        { status: 400 }\n      );\n    }\n    \n    // Parse desired ratio\n    const ratio = parseRatio(desiredRatio);\n    if (!ratio) {\n      return NextResponse.json(\n        { success: false, error: 'Invalid dilution ratio format' },\n        { status: 400 }\n      );\n    }\n    \n    // Calculate syrup and water amounts\n    const [syrupPart, waterPart] = ratio;\n    const totalParts = syrupPart + waterPart;\n    const syrupAmount = (volume * syrupPart) / totalParts;\n    const waterAmount = (volume * waterPart) / totalParts;\n    \n    // Get use case specific recommendations\n    const useCaseRecommendations = useCase ? \n      service.getDilutionRecommendations(syrup, useCase) : [];\n    \n    // Get taste adjustment suggestions\n    const tasteAdjustments = service.getTasteAdjustments(\n      syrup, \n      'too-sweet', // Default adjustment type\n      desiredRatio\n    );\n    \n    // Get storage recommendations\n    const storageRecommendations = service.getStorageRecommendations(syrup, volume);\n    \n    const calculation = {\n      inputs: {\n        syrupId,\n        targetVolume: volume,\n        desiredRatio: ratio,\n        useCase\n      },\n      results: {\n        syrupAmount: Math.round(syrupAmount * 100) / 100, // Round to 2 decimal places\n        waterAmount: Math.round(waterAmount * 100) / 100,\n        totalVolume: volume,\n        ratio: desiredRatio\n      },\n      recommendations: useCaseRecommendations,\n      tasteAdjustments,\n      storageRecommendations,\n      tips: [\n        'Mix syrup and water thoroughly for best results',\n        'Allow mixture to rest for 2-3 minutes before serving',\n        'Taste and adjust sweetness as needed',\n        'Store in refrigerator if not consuming immediately'\n      ]\n    };\n    \n    return NextResponse.json({\n      success: true,\n      data: calculation\n    });\n    \n  } catch (error) {\n    console.error('Error calculating dilution:', error);\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Failed to calculate dilution',\n        message: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * GET /api/syrups/dilution/recommendations - Get dilution recommendations by use case\n */\nexport async function GET_RECOMMENDATIONS(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const syrupId = searchParams.get('syrupId');\n    const useCase = searchParams.get('useCase') as 'coffee' | 'soda' | 'dessert' | 'beverage' | 'cocktail';\n    \n    if (!useCase) {\n      return NextResponse.json(\n        { success: false, error: 'useCase parameter is required' },\n        { status: 400 }\n      );\n    }\n    \n    const service = getDilutionService();\n    const syrupService = getSyrupService();\n    \n    let syrup: PremadeSyrup | null = null;\n    if (syrupId) {\n      syrup = syrupService.getSyrupById(syrupId);\n      if (!syrup) {\n        return NextResponse.json(\n          { success: false, error: `Syrup not found: ${syrupId}` },\n          { status: 404 }\n        );\n      }\n    }\n    \n    // Get recommendations for the use case\n    const recommendations = syrup ? \n      service.getDilutionRecommendations(syrup, useCase) :\n      // If no specific syrup, get general recommendations for the use case\n      getGeneralRecommendations(useCase);\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        useCase,\n        syrup: syrup ? {\n          id: syrup.id,\n          name: syrup.name,\n          brand: syrup.brand\n        } : null,\n        recommendations\n      }\n    });\n    \n  } catch (error) {\n    console.error('Error getting dilution recommendations:', error);\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Failed to get dilution recommendations',\n        message: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * Helper functions\n */\n\n/**\n * Parse volume string (e.g., \"1L\", \"500ml\", \"250 ML\")\n */\nfunction parseVolume(volumeStr: string): number | null {\n  const match = volumeStr.toLowerCase().match(/(\\d+(?:\\.\\d+)?)\\s*(ml|l)/);\n  if (!match) return null;\n  \n  const amount = parseFloat(match[1]);\n  const unit = match[2];\n  \n  return unit === 'l' ? amount * 1000 : amount;\n}\n\n/**\n * Parse dilution ratio string (e.g., \"1:1\", \"1:3\", \"2:1\")\n */\nfunction parseRatio(ratioStr: string): [number, number] | null {\n  const match = ratioStr.match(/(\\d+)\\s*:\\s*(\\d+)/);\n  if (!match) return null;\n  \n  const part1 = parseInt(match[1]);\n  const part2 = parseInt(match[2]);\n  \n  return [part1, part2];\n}\n\n/**\n * Get general dilution recommendations for use cases without specific syrup\n */\nfunction getGeneralRecommendations(useCase: string) {\n  const generalRecommendations = {\n    coffee: [\n      {\n        name: 'Coffee Enhancement',\n        ratio: '1:2',\n        description: 'Perfect for coffee drinks and lattes',\n        strength: 'medium' as const\n      },\n      {\n        name: 'Coffee Drizzle',\n        ratio: '1:1',\n        description: 'Concentrated for topping and drizzling',\n        strength: 'strong' as const\n      }\n    ],\n    soda: [\n      {\n        name: 'Light & Refreshing',\n        ratio: '1:4',\n        description: 'Light, refreshing soda drink',\n        strength: 'light' as const\n      },\n      {\n        name: 'Classic Soda',\n        ratio: '1:3',\n        description: 'Traditional soda flavor intensity',\n        strength: 'medium' as const\n      },\n      {\n        name: 'Strong & Bold',\n        ratio: '1:2',\n        description: 'Bold flavor for concentration',\n        strength: 'strong' as const\n      }\n    ],\n    dessert: [\n      {\n        name: 'Light Dessert',\n        ratio: '1:1',\n        description: 'Balanced sweetness for desserts',\n        strength: 'medium' as const\n      },\n      {\n        name: 'Concentrated Topping',\n        ratio: '1:0.5',\n        description: 'Concentrated for drizzling and topping',\n        strength: 'very-strong' as const\n      }\n    ],\n    beverage: [\n      {\n        name: 'Light Beverage',\n        ratio: '1:6',\n        description: 'Subtle flavor for all-day sipping',\n        strength: 'very-light' as const\n      },\n      {\n        name: 'Regular Beverage',\n        ratio: '1:3',\n        description: 'Standard beverage flavor',\n        strength: 'medium' as const\n      }\n    ],\n    cocktail: [\n      {\n        name: 'Cocktail Base',\n        ratio: '1:2',\n        description: 'Perfect for mixed drinks',\n        strength: 'medium' as const\n      },\n      {\n        name: 'Cocktail Concentrate',\n        ratio: '1:1',\n        description: 'Strong flavor for mixing',\n        strength: 'strong' as const\n      }\n    ]\n  };\n  \n  return generalRecommendations[useCase as keyof typeof generalRecommendations] || [];\n}"