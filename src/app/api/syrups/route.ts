/**
 * Syrups API Route
 * 
 * Main API endpoint for syrup database operations including search,
 * filtering, recommendations, and detailed syrup information.
 * 
 * @example
 * ```typescript\n * // Get all syrups\n * GET /api/syrups\n * \n * // Search syrups\n * GET /api/syrups?search=vanilla&brand=Torani\n * \n * // Get syrup by ID\n * GET /api/syrups/torani-vanilla-classic\n * \n * // Get recommendations\n * GET /api/syrups/recommendations?flavor=coffee&budget=15\n * ```\n */\n\nimport { NextRequest, NextResponse } from 'next/server';\nimport { PremadeSyrup, SyrupMarketplaceFilter } from '@/lib/types';\nimport { PremadeSyrupService } from '@/lib/premade-syrups';\nimport { syrupDatabase, getSyrupStatistics } from '@/data/syrups';\n\n/**\n * Initialize syrup service (singleton pattern)\n */\nlet syrupService: PremadeSyrupService | null = null;\n\nfunction getSyrupService(): PremadeSyrupService {\n  if (!syrupService) {\n    syrupService = new PremadeSyrupService();\n    // Override the internal database with our comprehensive one\n    (syrupService as any).syrups = syrupDatabase;\n  }\n  return syrupService;\n}\n\n/**\n * GET /api/syrups - Get syrups with filtering and search\n */\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const search = searchParams.get('search');\n    const brand = searchParams.get('brand');\n    const category = searchParams.get('category');\n    const concentration = searchParams.get('concentration');\n    const availability = searchParams.get('availability');\n    const minRating = searchParams.get('minRating');\n    const maxPrice = searchParams.get('maxPrice');\n    const sortBy = searchParams.get('sortBy') || 'popularity';\n    const sortOrder = searchParams.get('sortOrder') || 'desc';\n    const limit = parseInt(searchParams.get('limit') || '50');\n    const offset = parseInt(searchParams.get('offset') || '0');\n    \n    const service = getSyrupService();\n    \n    // Build filter object\n    const filter: SyrupMarketplaceFilter = {\n      searchQuery: search || '',\n      brands: brand ? [brand] : undefined,\n      categories: category ? [category] : undefined,\n      concentrations: concentration ? [concentration] : undefined,\n      availability: availability ? [availability] : undefined,\n      rating: minRating ? { min: parseFloat(minRating), max: 5 } : undefined,\n      priceRange: maxPrice ? { min: 0, max: parseFloat(maxPrice), currency: 'EUR' } : undefined,\n      sortBy: sortBy as any,\n      sortOrder: sortOrder as 'asc' | 'desc'\n    };\n    \n    // Get filtered syrups\n    const filteredSyrups = service.searchSyrups(filter);\n    \n    // Apply pagination\n    const total = filteredSyrups.length;\n    const paginatedSyrups = filteredSyrups.slice(offset, offset + limit);\n    \n    // Get available options for filters\n    const availableBrands = service.getBrands();\n    const availableCategories = service.getCategories();\n    const availableConcentrations = service.getConcentrations();\n    \n    // Get statistics\n    const statistics = getSyrupStatistics();\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        syrups: paginatedSyrups,\n        pagination: {\n          total,\n          limit,\n          offset,\n          hasMore: offset + limit < total\n        },\n        filters: {\n          brands: availableBrands,\n          categories: availableCategories,\n          concentrations: availableConcentrations\n        },\n        statistics\n      }\n    });\n    \n  } catch (error) {\n    console.error('Error fetching syrups:', error);\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Failed to fetch syrups',\n        message: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * POST /api/syrups - Create new syrup (admin only)\n */\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    \n    // TODO: Add authentication and authorization checks\n    // TODO: Add validation for syrup data\n    \n    const newSyrup: PremadeSyrup = body;\n    \n    // Validate required fields\n    if (!newSyrup.id || !newSyrup.brand || !newSyrup.name) {\n      return NextResponse.json(\n        { success: false, error: 'Missing required fields: id, brand, name' },\n        { status: 400 }\n      );\n    }\n    \n    // Check if syrup already exists\n    const existingSyrup = syrupDatabase.find(s => s.id === newSyrup.id);\n    if (existingSyrup) {\n      return NextResponse.json(\n        { success: false, error: 'Syrup with this ID already exists' },\n        { status: 409 }\n      );\n    }\n    \n    // TODO: Add syrup to database (in a real app, this would be saved to a database)\n    // For now, we'll just return success\n    \n    return NextResponse.json({\n      success: true,\n      data: {\n        syrup: newSyrup,\n        message: 'Syrup created successfully'\n      }\n    }, { status: 201 });\n    \n  } catch (error) {\n    console.error('Error creating syrup:', error);\n    return NextResponse.json(\n      { \n        success: false, \n        error: 'Failed to create syrup',\n        message: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    );\n  }\n}\n\n/**\n * Utility functions for the API\n */\n\n/**\n * Get syrup by ID\n */\nexport async function getSyrupById(id: string): Promise<PremadeSyrup | null> {\n  const service = getSyrupService();\n  return service.getSyrupById(id) || null;\n}\n\n/**\n * Get syrup recommendations for a flavor\n */\nexport async function getSyrupRecommendations(\n  flavor: string,\n  options?: {\n    budget?: number;\n    brand?: string;\n    maxRating?: number;\n    availability?: string;\n  }\n) {\n  const service = getSyrupService();\n  return service.getRecommendations(flavor, options);\n}\n\n/**\n * Search syrups with advanced filters\n */\nexport async function searchSyrupsAdvanced(filter: SyrupMarketplaceFilter) {\n  const service = getSyrupService();\n  return service.searchSyrups(filter);\n}"