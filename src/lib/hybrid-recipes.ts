/**
 * Hybrid Recipe Mode Service
 * 
 * Implements advanced hybrid recipe functionality that combines DIY base recipes
 * with commercial syrup enhancements, providing gradual flavor building,
 * cost optimization, and quality enhancement through strategic ingredient mixing.
 * 
 * @example
 * ```typescript\n * import { HybridRecipeService } from './hybrid-recipes';\n * \n * const hybridService = new HybridRecipeService();\n * const hybridRecipe = await hybridService.createHybridRecipe({\n *   baseRecipe: diyRecipe,\n *   syrupEnhancements: ['torani-vanilla'],\n *   customAdditions: [{ type: 'extract', id: 'coffee-extract', amount: 0.5 }],\n *   budget: 15,\n *   qualityTarget: 'high'\n * });\n * ```\n */\n\nimport { PremadeSyrup, PremadeMode, CostComparison, FlavorRecipe, BaseRecipe } from './types';\nimport { PremadeSyrupService } from './premade-syrups';\n\n/**\n * Hybrid Recipe Creation Options\n * \n * Configuration options for creating hybrid recipes that combine\n * DIY and commercial approaches.\n */\nexport interface HybridRecipeOptions {\n  baseRecipe?: BaseRecipe;\n  targetFlavor?: string;\n  syrupEnhancements?: string[]; // Syrup IDs to use\n  customAdditions?: Array<{\n    type: 'extract' | 'oil' | 'acid' | 'sweetener' | 'preservative';\n    id: string;\n    amount: number;\n    unit: 'ml' | 'g' | 'tsp' | 'drops';\n  }>;\n  budget?: number;\n  qualityTarget?: 'basic' | 'good' | 'high' | 'premium';\n  preparationTime?: number; // maximum minutes\n  complexity?: 'beginner' | 'intermediate' | 'advanced';\n  tasteProfile?: {\n    sweetness?: 'very-low' | 'low' | 'medium' | 'high' | 'very-high';\n    intensity?: 'subtle' | 'moderate' | 'strong' | 'very-strong';\n    notes?: string[];\n  };\n}\n\n/**\n * Hybrid Recipe Result\n * \n * Complete hybrid recipe with both DIY and commercial components,\n * cost analysis, and optimization recommendations.\n */\nexport interface HybridRecipeResult {\n  recipe: PremadeMode;\n  baseSyrup?: PremadeSyrup;\n  enhancements: Array<{\n    syrup: PremadeSyrup;\n    addition: PremadeMode['customAdditions'][0];\n    purpose: string;\n    impact: 'high' | 'medium' | 'low';\n  }>;\n  costAnalysis: CostComparison;\n  instructions: string[];\n  tips: string[];\n  alternatives: HybridRecipeResult[];\n  optimizationSuggestions: {\n    costReduction: string[];\n    qualityImprovement: string[];\n    convenienceEnhancement: string[];\n  };\n}\n\n/**\n * Layered Flavor Building Strategy\n * \n * Defines the order and timing of ingredient additions\n * for optimal flavor development in hybrid recipes.\n */\nexport interface FlavorLayer {\n  step: number;\n  component: 'base-syrup' | 'custom-extract' | 'enhancement' | 'acid' | 'sweetener';\n  ingredient: string;\n  amount: string;\n  timing: 'immediate' | 'after-5min' | 'after-15min' | 'before-serving';\n  purpose: string;\n  technique: string;\n}\n\n/**\n * Quality Enhancement Matrix\n * \n * Maps commercial extracts to quality improvement opportunities\n * for different recipe types and flavor profiles.\n */\nexport interface QualityEnhancement {\n  type: 'extract' | 'oil' | 'powder' | 'concentrate';\n  ingredient: string;\n  qualityScore: number; // 0-100\n  enhancementTypes: {\n    tasteAccuracy: number;\n    flavorComplexity: number;\n    mouthfeel: number;\n    aroma: number;\n    aftertaste: number;\n  };\n  compatibleFlavors: string[];\n  usageRecommendations: string[];\n}\n\n/**\n * Hybrid Recipe Service\n * \n * Central service for creating, optimizing, and managing hybrid recipes\n * that combine DIY approaches with commercial syrup enhancements.\n */\nexport class HybridRecipeService {\n  private syrupService: PremadeSyrupService;\n  private qualityEnhancements: QualityEnhancement[] = [];\n  private layeringStrategies: Map<string, FlavorLayer[]> = new Map();\n  \n  constructor(syrupService: PremadeSyrupService) {\n    this.syrupService = syrupService;\n    this.initializeQualityEnhancements();\n    this.initializeLayeringStrategies();\n  }\n\n  /**\n   * Initialize quality enhancement database\n   */\n  private initializeQualityEnhancements(): void {\n    this.qualityEnhancements = [\n      {\n        type: 'extract',\n        ingredient: 'madagascar-vanilla-extract',\n        qualityScore: 95,\n        enhancementTypes: {\n          tasteAccuracy: 95,\n          flavorComplexity: 90,\n          mouthfeel: 85,\n          aroma: 95,\n          aftertaste: 90\n        },\n        compatibleFlavors: ['vanilla', 'cream', 'coffee', 'dessert'],\n        usageRecommendations: [\n          'Add 2-3 drops after syrup mixing',\n          'Perfect for coffee drinks and desserts',\n          'Can substitute for vanilla syrup at 10% concentration'\n        ]\n      },\n      {\n        type: 'extract',\n        ingredient: 'coffee-extract',\n        qualityScore: 92,\n        enhancementTypes: {\n          tasteAccuracy: 95,\n          flavorComplexity: 88,\n          mouthfeel: 80,\n          aroma: 90,\n          aftertaste: 85\n        },\n        compatibleFlavors: ['coffee', 'vanilla', 'caramel', 'hazelnut'],\n        usageRecommendations: [\n          'Add 1-2 drops per 250ml for coffee enhancement',\n          'Excellent for energy drinks',\n          'Can replace coffee syrup at 5% concentration'\n        ]\n      },\n      {\n        type: 'oil',\n        ingredient: 'orange-essential-oil',\n        qualityScore: 88,\n        enhancementTypes: {\n          tasteAccuracy: 85,\n          flavorComplexity: 90,\n          mouthfeel: 75,\n          aroma: 95,\n          aftertaste: 80\n        },\n        compatibleFlavors: ['citrus', 'orange', 'lemon', 'lime'],\n        usageRecommendations: [\n          'Use 1-2 drops maximum per liter',\n          'Add just before serving',\n          'Great for citrus sodas and energy drinks'\n        ]\n      },\n      {\n        type: 'oil',\n        ingredient: 'peppermint-oil',\n        qualityScore: 85,\n        enhancementTypes: {\n          tasteAccuracy: 90,\n          flavorComplexity: 85,\n          mouthfeel: 70,\n          aroma: 95,\n          aftertaste: 85\n        },\n        compatibleFlavors: ['mint', 'peppermint', 'cooling', 'fresh'],\n        usageRecommendations: [\n          'Use 1 drop per 500ml maximum',\n          'Add at the very end',\n          'Perfect for summer drinks and refreshment'\n        ]\n      },\n      {\n        type: 'concentrate',\n        ingredient: 'fruit-puree-concentrate',\n        qualityScore: 90,\n        enhancementTypes: {\n          tasteAccuracy: 92,\n          flavorComplexity: 85,\n          mouthfeel: 90,\n          aroma: 88,\n          aftertaste: 85\n        },\n        compatibleFlavors: ['berry', 'fruit', 'tropical', 'citrus'],\n        usageRecommendations: [\n          'Mix 1:4 with base syrup',\n          'Excellent for authentic fruit flavors',\n          'Can replace fruit syrups at higher cost but better quality'\n        ]\n      },\n      {\n        type: 'extract',\n        ingredient: 'caramel-extract',\n        qualityScore: 87,\n        enhancementTypes: {\n          tasteAccuracy: 90,\n          flavorComplexity: 85,\n          mouthfeel: 88,\n          aroma: 85,\n          aftertaste: 90\n        },\n        compatibleFlavors: ['caramel', 'coffee', 'vanilla', 'dessert'],\n        usageRecommendations: [\n          'Add 2-4 drops per 250ml',\n          'Enhances caramel syrups naturally',\n          'Great for coffee house style drinks'\n        ]\n      },\n      {\n        type: 'powder',\n        ingredient: 'cinnamon-powder',\n        qualityScore: 82,\n        enhancementTypes: {\n          tasteAccuracy: 80,\n          flavorComplexity: 85,\n          mouthfeel: 75,\n          aroma: 90,\n          aftertaste: 80\n        },\n        compatibleFlavors: ['spice', 'autumn', 'warm', 'dessert'],\n        usageRecommendations: [\n          'Use 1/4 tsp per liter maximum',\n          'Add early in mixing process',\n          'Perfect for pumpkin spice and warm drinks'\n        ]\n      },\n      {\n        type: 'extract',\n        ingredient: 'hazelnut-extract',\n        qualityScore: 89,\n        enhancementTypes: {\n          tasteAccuracy: 92,\n          flavorComplexity: 87,\n          mouthfeel: 85,\n          aroma: 88,\n          aftertaste: 87\n        },\n        compatibleFlavors: ['hazelnut', 'coffee', 'cream', 'dessert'],\n        usageRecommendations: [\n          'Add 1-2 drops per 250ml',\n          'Excellent for coffee drinks',\n          'More concentrated than hazelnut syrup'\n        ]\n      }\n    ];\n  }\n\n  /**\n   * Initialize flavor layering strategies\n   */\n  private initializeLayeringStrategies(): void {\n    // VANILLA-BASED LAYERING\n    this.layeringStrategies.set('vanilla-hybrid', [\n      {\n        step: 1,\n        component: 'base-syrup',\n        ingredient: 'torani-vanilla',\n        amount: '250ml syrup',\n        timing: 'immediate',\n        purpose: 'Establish vanilla foundation',\n        technique: 'Mix with base liquid using 1:3 ratio'\n      },\n      {\n        step: 2,\n        component: 'custom-extract',\n        ingredient: 'madagascar-vanilla-extract',\n        amount: '3 drops',\n        timing: 'after-5min',\n        purpose: 'Enhance vanilla complexity',\n        technique: 'Add drops individually, tasting between additions'\n      },\n      {\n        step: 3,\n        component: 'enhancement',\n        ingredient: 'coffee-extract',\n        amount: '2 drops',\n        timing: 'after-15min',\n        purpose: 'Add coffeehouse depth',\n        technique: 'Gentle incorporation to avoid overpowering'\n      },\n      {\n        step: 4,\n        component: 'sweetener',\n        ingredient: 'simple-syrup',\n        amount: '5ml',\n        timing: 'before-serving',\n        purpose: 'Balance and smooth',\n        technique: 'Final taste adjustment and smoothing'\n      }\n    ]);\n\n    // CITRUS-HYBRID LAYERING\n    this.layeringStrategies.set('citrus-hybrid', [\n      {\n        step: 1,\n        component: 'base-syrup',\n        ingredient: 'sodastream-lemon-lime',\n        amount: '200ml syrup',\n        timing: 'immediate',\n        purpose: 'Create citrus foundation',\n        technique: 'Mix with carbonated water for effervescence'\n      },\n      {\n        step: 2,\n        component: 'acid',\n        ingredient: 'fresh-lemon-juice',\n        amount: '10ml',\n        timing: 'after-5min',\n        purpose: 'Brighten and enhance acidity',\n        technique: 'Fresh juice adds natural brightness'\n      },\n      {\n        step: 3,\n        component: 'oil',\n        ingredient: 'orange-essential-oil',\n        amount: '1 drop',\n        timing: 'before-serving',\n        purpose: 'Add aromatic complexity',\n        technique: 'Single drop for maximum aroma impact'\n      }\n    ]);\n\n    // CARAMEL-HYBRID LAYERING\n    this.layeringStrategies.set('caramel-hybrid', [\n      {\n        step: 1,\n        component: 'base-syrup',\n        ingredient: 'torani-caramel',\n        amount: '300ml syrup',\n        timing: 'immediate',\n        purpose: 'Establish caramel base',\n        technique: 'Mix with warm base liquid for better dissolution'\n      },\n      {\n        step: 2,\n        component: 'custom-extract',\n        ingredient: 'caramel-extract',\n        amount: '4 drops',\n        timing: 'after-5min',\n        purpose: 'Intensify caramel notes',\n        technique: 'Drops added slowly with constant tasting'\n      },\n      {\n        step: 3,\n        component: 'enhancement',\n        ingredient: 'vanilla-extract',\n        amount: '2 drops',\n        timing: 'after-15min',\n        purpose: 'Add vanilla complexity',\n        technique: 'Vanilla rounds out the caramel flavor'\n      },\n      {\n        step: 4,\n        component: 'sweetener',\n        ingredient: 'brown-sugar-syrup',\n        amount: '10ml',\n        timing: 'before-serving',\n        purpose: 'Enhance molasses notes',\n        technique: 'Final sweetness adjustment with complexity'\n      }\n    ]);\n\n    // BERRY-HYBRID LAYERING\n    this.layeringStrategies.set('berry-hybrid', [\n      {\n        step: 1,\n        component: 'base-syrup',\n        ingredient: 'davinci-raspberry',\n        amount: '250ml syrup',\n        timing: 'immediate',\n        purpose: 'Create berry foundation',\n        technique: 'Mix with cold liquid to preserve fruit notes'\n      },\n      {\n        step: 2,\n        component: 'enhancement',\n        ingredient: 'fruit-puree-concentrate',\n        amount: '15ml',\n        timing: 'after-5min',\n        purpose: 'Intensify fruit authenticity',\n        technique: 'Puree adds natural fruit character'\n      },\n      {\n        step: 3,\n        component: 'acid',\n        ingredient: 'citric-acid',\n        amount: 'pinch',\n        timing: 'after-15min',\n        purpose: 'Enhance tartness',\n        technique: 'Tiny amounts to avoid over-acidic taste'\n      },\n      {\n        step: 4,\n        component: 'sweetener',\n        ingredient: 'honey-syrup',\n        amount: '8ml',\n        timing: 'before-serving',\n        purpose: 'Balance tartness with floral sweetness',\n        technique: 'Honey adds complexity beyond simple sugar'\n      }\n    ]);\n\n    // COFFEE-HYBRID LAYERING\n    this.layeringStrategies.set('coffee-hybrid', [\n      {\n        step: 1,\n        component: 'base-syrup',\n        ingredient: 'starbucks-vanilla',\n        amount: '200ml syrup',\n        timing: 'immediate',\n        purpose: 'Establish coffeehouse base',\n        technique: 'Use premium syrup as foundation'\n      },\n      {\n        step: 2,\n        component: 'custom-extract',\n        ingredient: 'coffee-extract',\n        amount: '4 drops',\n        timing: 'after-5min',\n        purpose: 'Intensify coffee character',\n        technique: 'Concentrated coffee flavor without bitterness'\n      },\n      {\n        step: 3,\n        component: 'enhancement',\n        ingredient: 'hazelnut-extract',\n        amount: '2 drops',\n        timing: 'after-15min',\n        purpose: 'Add nutty complexity',\n        technique: 'Hazelnut complements coffee naturally'\n      },\n      {\n        step: 4,\n        component: 'sweetener',\n        ingredient: 'brown-sugar-syrup',\n        amount: '12ml',\n        timing: 'before-serving',\n        purpose: 'Enhance coffeehouse authenticity',\n        technique: 'Brown sugar adds caramel notes to coffee'\n      }\n    ]);\n  }\n\n  /**\n   * Create a hybrid recipe combining DIY and commercial approaches\n   */\n  public async createHybridRecipe(options: HybridRecipeOptions): Promise<HybridRecipeResult> {\n    const {\n      baseRecipe,\n      targetFlavor = 'vanilla',\n      syrupEnhancements = [],\n      customAdditions = [],\n      budget = 20,\n      qualityTarget = 'good',\n      preparationTime = 15,\n      complexity = 'intermediate',\n      tasteProfile = {}\n    } = options;\n\n    // Get recommended syrups for target flavor\n    const recommendations = this.syrupService.getRecommendations(targetFlavor, {\n      budget,\n      availability: 'in-stock'\n    });\n\n    if (recommendations.length === 0) {\n      throw new Error(`No suitable syrups found for ${targetFlavor} within budget ${budget}`);\n    }\n\n    // Select best syrup based on quality target\n    const selectedSyrup = this.selectBestSyrup(recommendations, qualityTarget);\n    \n    // Create custom additions based on target flavor and quality\n    const enhancedAdditions = this.generateCustomAdditions(\n      targetFlavor,\n      customAdditions,\n      qualityTarget\n    );\n\n    // Calculate dilution ratio based on preparation method\n    const dilutionRatio = this.calculateOptimalDilution(\n      selectedSyrup,\n      enhancedAdditions,\n      targetFlavor\n    );\n\n    // Generate layered preparation instructions\n    const layeringStrategy = this.generateLayeringStrategy(\n      targetFlavor,\n      selectedSyrup,\n      enhancedAdditions\n    );\n\n    // Calculate cost analysis\n    const costAnalysis = await this.calculateHybridCostAnalysis(\n      selectedSyrup,\n      enhancedAdditions,\n      dilutionRatio,\n      baseRecipe\n    );\n\n    // Create the hybrid recipe\n    const hybridRecipe: PremadeMode = {\n      mode: 'hybrid',\n      baseSyrup: selectedSyrup.id,\n      customAdditions: enhancedAdditions,\n      dilutionRatio,\n      estimatedCost: {\n        amount: costAnalysis.hybrid.total,\n        currency: 'EUR',\n        breakdown: {\n          syrup: costAnalysis.hybrid.syrup,\n          customAdditions: costAnalysis.hybrid.customAdditions,\n          labor: costAnalysis.hybrid.labor\n        }\n      },\n      preparationTime: this.calculatePreparationTime(layeringStrategy),\n      difficulty: complexity,\n      qualityScore: this.calculateQualityScore(selectedSyrup, enhancedAdditions),\n      tasteAccuracy: this.calculateTasteAccuracy(targetFlavor, selectedSyrup, enhancedAdditions)\n    };\n\n    // Generate optimization suggestions\n    const optimizationSuggestions = this.generateOptimizationSuggestions(\n      hybridRecipe,\n      costAnalysis,\n      qualityTarget\n    );\n\n    // Create enhancement mapping\n    const enhancements = enhancedAdditions.map(addition => {\n      const qualityEnhancement = this.qualityEnhancements.find(\n        qe => qe.ingredient === addition.id\n      );\n      \n      return {\n        syrup: selectedSyrup,\n        addition,\n        purpose: this.getEnhancementPurpose(addition, targetFlavor),\n        impact: qualityEnhancement?.qualityScore > 85 ? 'high' : \n                qualityEnhancement?.qualityScore > 70 ? 'medium' : 'low'\n      };\n    });\n\n    return {\n      recipe: hybridRecipe,\n      baseSyrup: selectedSyrup,\n      enhancements,\n      costAnalysis,\n      instructions: this.generateHybridInstructions(layeringStrategy),\n      tips: this.generateHybridTips(targetFlavor, selectedSyrup, enhancedAdditions),\n      alternatives: await this.generateAlternatives(options, selectedSyrup),\n      optimizationSuggestions\n    };\n  }\n\n  /**\n   * Select the best syrup based on quality target and recommendations\n   */\n  private selectBestSyrup(\n    recommendations: any[],\n    qualityTarget: HybridRecipeOptions['qualityTarget']\n  ): PremadeSyrup {\n    const weights = {\n      basic: { compatibility: 0.3, rating: 0.2, price: 0.5 },\n      good: { compatibility: 0.4, rating: 0.3, price: 0.3 },\n      high: { compatibility: 0.5, rating: 0.4, price: 0.1 },\n      premium: { compatibility: 0.6, rating: 0.5, price: 0.1 }\n    };\n\n    const weight = weights[qualityTarget];\n    \n    return recommendations.reduce((best, current) => {\n      const bestScore = \n        best.compatibilityScore * weight.compatibility +\n        best.syrup.rating * weight.rating +\n        (100 - Math.min(...Object.values(best.syrup.regionalPricing).map(p => p.price))) * weight.price;\n      \n      const currentScore = \n        current.compatibilityScore * weight.compatibility +\n        current.syrup.rating * weight.rating +\n        (100 - Math.min(...Object.values(current.syrup.regionalPricing).map(p => p.price))) * weight.price;\n      \n      return currentScore > bestScore ? current : best;\n    }).syrup;\n  }\n\n  /**\n   * Generate custom additions based on target flavor and quality requirements\n   */\n  private generateCustomAdditions(\n    targetFlavor: string,\n    existingAdditions: HybridRecipeOptions['customAdditions'] = [],\n    qualityTarget: HybridRecipeOptions['qualityTarget'] = 'good'\n  ): PremadeMode['customAdditions'] {\n    const additions = [...existingAdditions];\n    \n    // Add quality enhancements based on target flavor and quality level\n    const qualityAdditions = this.getQualityAdditionsForFlavor(targetFlavor, qualityTarget);\n    \n    additions.push(...qualityAdditions.filter(\n      addition => !additions.some(existing => existing.id === addition.id)\n    ));\n    \n    return additions;\n  }\n\n  /**\n   * Get quality enhancements for specific flavors\n   */\n  private getQualityAdditionsForFlavor(\n    flavor: string,\n    qualityTarget: HybridRecipeOptions['qualityTarget']\n  ): PremadeMode['customAdditions'] {\n    const qualityMap = {\n      vanilla: {\n        basic: [],\n        good: [{ type: 'extract', id: 'madagascar-vanilla-extract', amount: 2, unit: 'drops' }],\n        high: [\n          { type: 'extract', id: 'madagascar-vanilla-extract', amount: 3, unit: 'drops' },\n          { type: 'extract', id: 'coffee-extract', amount: 1, unit: 'drops' }\n        ],\n        premium: [\n          { type: 'extract', id: 'madagascar-vanilla-extract', amount: 3, unit: 'drops' },\n          { type: 'extract', id: 'coffee-extract', amount: 2, unit: 'drops' },\n          { type: 'sweetener', id: 'vanilla-sugar', amount: 0.5, unit: 'tsp' }\n        ]\n      },\n      citrus: {\n        basic: [],\n        good: [{ type: 'oil', id: 'orange-essential-oil', amount: 1, unit: 'drops' }],\n        high: [\n          { type: 'oil', id: 'orange-essential-oil', amount: 2, unit: 'drops' },\n          { type: 'acid', id: 'citric-acid', amount: 0.1, unit: 'tsp' }\n        ],\n        premium: [\n          { type: 'oil', id: 'orange-essential-oil', amount: 2, unit: 'drops' },\n          { type: 'oil', id: 'lemon-essential-oil', amount: 1, unit: 'drops' },\n          { type: 'acid', id: 'fresh-lemon-juice', amount: 5, unit: 'ml' }\n        ]\n      },\n      caramel: {\n        basic: [],\n        good: [{ type: 'extract', id: 'caramel-extract', amount: 2, unit: 'drops' }],\n        high: [\n          { type: 'extract', id: 'caramel-extract', amount: 3, unit: 'drops' },\n          { type: 'extract', id: 'vanilla-extract', amount: 1, unit: 'drops' }\n        ],\n        premium: [\n          { type: 'extract', id: 'caramel-extract', amount: 4, unit: 'drops' },\n          { type: 'extract', id: 'vanilla-extract', amount: 2, unit: 'drops' },\n          { type: 'sweetener', id: 'brown-sugar-syrup', amount: 5, unit: 'ml' }\n        ]\n      },\n      berry: {\n        basic: [],\n        good: [{ type: 'concentrate', id: 'fruit-puree-concentrate', amount: 10, unit: 'ml' }],\n        high: [\n          { type: 'concentrate', id: 'fruit-puree-concentrate', amount: 15, unit: 'ml' },\n          { type: 'acid', id: 'citric-acid', amount: 0.1, unit: 'tsp' }\n        ],\n        premium: [\n          { type: 'concentrate', id: 'fruit-puree-concentrate', amount: 20, unit: 'ml' },\n          { type: 'acid', id: 'raspberry-acid', amount: 0.2, unit: 'tsp' },\n          { type: 'sweetener', id: 'honey-syrup', amount: 5, unit: 'ml' }\n        ]\n      },\n      coffee: {\n        basic: [],\n        good: [{ type: 'extract', id: 'coffee-extract', amount: 2, unit: 'drops' }],\n        high: [\n          { type: 'extract', id: 'coffee-extract', amount: 3, unit: 'drops' },\n          { type: 'extract', id: 'hazelnut-extract', amount: 1, unit: 'drops' }\n        ],\n        premium: [\n          { type: 'extract', id: 'coffee-extract', amount: 4, unit: 'drops' },\n          { type: 'extract', id: 'hazelnut-extract', amount: 2, unit: 'drops' },\n          { type: 'sweetener', id: 'brown-sugar-syrup', amount: 8, unit: 'ml' }\n        ]\n      }\n    };\n\n    return qualityMap[flavor as keyof typeof qualityMap]?.[qualityTarget] || [];\n  }\n\n  /**\n   * Calculate optimal dilution ratio based on syrup and additions\n   */\n  private calculateOptimalDilution(\n    syrup: PremadeSyrup,\n    additions: PremadeMode['customAdditions'],\n    targetFlavor: string\n  ): string {\n    const baseRatio = syrup.dilutionRatio;\n    const [syrupPart, waterPart] = baseRatio.split(':').map(Number);\n    \n    // Adjust dilution based on custom additions intensity\n    let intensityFactor = 1;\n    \n    additions.forEach(addition => {\n      switch (addition.type) {\n        case 'extract':\n          intensityFactor *= 1.1; // Extracts add intensity\n          break;\n        case 'oil':\n          intensityFactor *= 1.05; // Oils add aroma more than taste\n          break;\n        case 'concentrate':\n          intensityFactor *= 0.95; // Concentrates may need more dilution\n          break;\n        case 'acid':\n          intensityFactor *= 0.9; // Acids can make things taste stronger\n          break;\n      }\n    });\n    \n    // Calculate adjusted water ratio\n    const adjustedWaterPart = Math.round(waterPart * intensityFactor);\n    \n    return `${syrupPart}:${adjustedWaterPart}`;\n  }\n\n  /**\n   * Generate layering strategy for hybrid recipe\n   */\n  private generateLayeringStrategy(\n    targetFlavor: string,\n    syrup: PremadeSyrup,\n    additions: PremadeMode['customAdditions']\n  ): FlavorLayer[] {\n    const baseStrategy = this.layeringStrategies.get(`${targetFlavor}-hybrid`);\n    \n    if (!baseStrategy) {\n      // Create default strategy if specific one doesn't exist\n      return [\n        {\n          step: 1,\n          component: 'base-syrup',\n          ingredient: syrup.name,\n          amount: '250ml syrup',\n          timing: 'immediate',\n          purpose: 'Establish base flavor',\n          technique: 'Mix with appropriate liquid ratio'\n        },\n        {\n          step: 2,\n          component: 'custom-extract',\n          ingredient: additions[0]?.id || 'flavor-enhancer',\n          amount: `${additions[0]?.amount || 2} ${additions[0]?.unit || 'drops'}`,\n          timing: 'after-5min',\n          purpose: 'Add complexity',\n          technique: 'Gradual addition with tasting'\n        }\n      ];\n    }\n    \n    return baseStrategy;\n  }\n\n  /**\n   * Calculate preparation time based on layering strategy\n   */\n  private calculatePreparationTime(layeringStrategy: FlavorLayer[]): number {\n    let totalTime = 5; // Base preparation time\n    \n    layeringStrategy.forEach(layer => {\n      switch (layer.timing) {\n        case 'immediate':\n          totalTime += 1;\n          break;\n        case 'after-5min':\n          totalTime += 6;\n          break;\n        case 'after-15min':\n          totalTime += 16;\n          break;\n        case 'before-serving':\n          totalTime += 2;\n          break;\n      }\n    });\n    \n    return totalTime;\n  }\n\n  /**\n   * Calculate overall quality score for hybrid recipe\n   */\n  private calculateQualityScore(\n    syrup: PremadeSyrup,\n    additions: PremadeMode['customAdditions']\n  ): number {\n    let score = syrup.rating * 20; // Base syrup score (0-100)\n    \n    additions.forEach(addition => {\n      const enhancement = this.qualityEnhancements.find(\n        qe => qe.ingredient === addition.id\n      );\n      \n      if (enhancement) {\n        score += enhancement.qualityScore * 0.1; // Additions contribute 10% each\n      }\n    });\n    \n    return Math.min(100, Math.round(score));\n  }\n\n  /**\n   * Calculate taste accuracy score\n   */\n  private calculateTasteAccuracy(\n    targetFlavor: string,\n    syrup: PremadeSyrup,\n    additions: PremadeMode['customAdditions']\n  ): number {\n    let accuracy = syrup.rating * 20; // Base accuracy from syrup\n    \n    // Add bonus for compatible additions\n    additions.forEach(addition => {\n      const enhancement = this.qualityEnhancements.find(\n        qe => qe.ingredient === addition.id\n      );\n      \n      if (enhancement && enhancement.compatibleFlavors.includes(targetFlavor)) {\n        accuracy += 10;\n      }\n    });\n    \n    return Math.min(100, Math.round(accuracy));\n  }\n\n  /**\n   * Generate hybrid instructions\n   */\n  private generateHybridInstructions(layeringStrategy: FlavorLayer[]): string[] {\n    const instructions: string[] = [];\n    \n    layeringStrategy.forEach(layer => {\n      instructions.push(\n        `Step ${layer.step}: ${layer.purpose}`,\n        `- Add ${layer.amount} of ${layer.ingredient}`,\n        `- Timing: ${layer.timing.replace('-', ' ')}`,\n        `- Technique: ${layer.technique}`,\n        ''\n      );\n    });\n    \n    instructions.push(\n      'Final Steps:',\n      '- Taste and adjust sweetness if needed',\n      '- Add carbonation if desired',\n      '- Serve immediately or chill for later'\n    );\n    \n    return instructions;\n  }\n\n  /**\n   * Generate hybrid tips\n   */\n  private generateHybridTips(\n    targetFlavor: string,\n    syrup: PremadeSyrup,\n    additions: PremadeMode['customAdditions']\n  ): string[] {\n    const tips: string[] = [];\n    \n    // General hybrid tips\n    tips.push(\n      'Use high-quality ingredients for best results',\n      'Taste at each step to ensure proper balance',\n      'Store in refrigerator after preparation',\n      'Consume within 24-48 hours for optimal flavor'\n    );\n    \n    // Syrup-specific tips\n    if (syrup.brand === 'Torani') {\n      tips.push('Torani syrups are highly concentrated - start with less and add more');\n    }\n    \n    if (syrup.brand === 'Monin') {\n      tips.push('Monin syrups pair excellently with premium extracts');\n    }\n    \n    // Addition-specific tips\n    additions.forEach(addition => {\n      if (addition.type === 'extract') {\n        tips.push('Essential oils are potent - start with less and add gradually');\n      }\n      \n      if (addition.type === 'oil') {\n        tips.push('Essential oils should be added just before serving for maximum aroma');\n      }\n    });\n    \n    return tips;\n  }\n\n  /**\n   * Generate alternative hybrid recipes\n   */\n  private async generateAlternatives(\n    options: HybridRecipeOptions,\n    selectedSyrup: PremadeSyrup\n  ): Promise<HybridRecipeResult[]> {\n    const alternatives: HybridRecipeResult[] = [];\n    \n    // Generate 2-3 alternatives with different approaches\n    const alternativeOptions = [\n      {\n        ...options,\n        qualityTarget: 'good' as const,\n        budget: Math.max(5, (options.budget || 20) - 5)\n      },\n      {\n        ...options,\n        qualityTarget: 'premium' as const,\n        budget: (options.budget || 20) + 10\n      }\n    ];\n    \n    for (const altOptions of alternativeOptions) {\n      try {\n        const alternative = await this.createHybridRecipe(altOptions);\n        alternatives.push(alternative);\n      } catch (error) {\n        // Skip alternatives that can't be created\n      }\n    }\n    \n    return alternatives;\n  }\n\n  /**\n   * Calculate cost analysis for hybrid recipe\n   */\n  private async calculateHybridCostAnalysis(\n    syrup: PremadeSyrup,\n    additions: PremadeMode['customAdditions'],\n    dilutionRatio: string,\n    baseRecipe?: BaseRecipe\n  ): Promise<CostComparison> {\n    const syrupPrice = Math.min(...Object.values(syrup.regionalPricing).map(p => p.price));\n    \n    const additionsCost = additions.reduce((total, addition) => {\n      const baseCost = this.getIngredientCost(addition.id);\n      return total + (baseCost * addition.amount / 100); // Assuming costs are per 100 units\n    }, 0);\n    \n    const laborCost = 8; // 8 minutes at $60/hour\n    const totalHybridCost = syrupPrice + additionsCost + laborCost;\n    \n    return {\n      diy: {\n        ingredients: 0,\n        labor: 25,\n        equipment: 2,\n        total: 27,\n        costPerServing: 1.35\n      },\n      premade: {\n        syrup: syrupPrice,\n        customAdditions: 0,\n        labor: 3,\n        total: syrupPrice + 3,\n        costPerServing: (syrupPrice + 3) / 20\n      },\n      hybrid: {\n        syrup: syrupPrice,\n        customAdditions: additionsCost,\n        labor: laborCost,\n        total: totalHybridCost,\n        costPerServing: totalHybridCost / 20\n      },\n      savings: 27 - totalHybridCost,\n      recommendation: totalHybridCost < 27 ? 'hybrid' : 'premade',\n      qualityFactors: {\n        tasteMatch: 85,\n        convenience: 75,\n        customization: 90,\n        freshness: 85\n      }\n    };\n  }\n\n  /**\n   * Get estimated cost for ingredient\n   */\n  private getIngredientCost(ingredientId: string): number {\n    const costMap: Record<string, number> = {\n      'madagascar-vanilla-extract': 15,\n      'coffee-extract': 12,\n      'orange-essential-oil': 18,\n      'peppermint-oil': 16,\n      'fruit-puree-concentrate': 20,\n      'caramel-extract': 14,\n      'hazelnut-extract': 16,\n      'cinnamon-powder': 8,\n      'citric-acid': 5,\n      'simple-syrup': 3,\n      'honey-syrup': 8,\n      'brown-sugar-syrup': 6\n    };\n    \n    return costMap[ingredientId] || 10;\n  }\n\n  /**\n   * Generate optimization suggestions\n   */\n  private generateOptimizationSuggestions(\n    recipe: PremadeMode,\n    costAnalysis: CostComparison,\n    qualityTarget: HybridRecipeOptions['qualityTarget']\n  ): HybridRecipeResult['optimizationSuggestions'] {\n    const costReduction: string[] = [];\n    const qualityImprovement: string[] = [];\n    const convenienceEnhancement: string[] = [];\n    \n    // Cost reduction suggestions\n    if (costAnalysis.hybrid.total > costAnalysis.premade.total) {\n      costReduction.push('Consider using fewer custom additions to reduce costs');\n      costReduction.push('Buy syrups in bulk for better per-unit pricing');\n    }\n    \n    if (recipe.estimatedCost.amount > 15) {\n      costReduction.push('Substitute premium extracts with standard alternatives');\n    }\n    \n    // Quality improvement suggestions\n    if (recipe.qualityScore < 85) {\n      qualityImprovement.push('Add high-quality extracts for better flavor complexity');\n      qualityImprovement.push('Use premium syrups as base for enhanced taste');\n    }\n    \n    if (recipe.tasteAccuracy < 90) {\n      qualityImprovement.push('Adjust layering sequence for better flavor integration');\n      qualityImprovement.push('Fine-tune dilution ratios for optimal taste balance');\n    }\n    \n    // Convenience enhancement suggestions\n    if (recipe.preparationTime > 15) {\n      convenienceEnhancement.push('Prepare base syrup in larger batches for efficiency');\n      convenienceEnhancement.push('Use pre-measured extract bottles for faster preparation');\n    }\n    \n    if (recipe.difficulty === 'advanced') {\n      convenienceEnhancement.push('Simplify layering for easier preparation');\n      convenienceEnhancement.push('Use automated measuring tools for consistency');\n    }\n    \n    return {\n      costReduction,\n      qualityImprovement,\n      convenienceEnhancement\n    };\n  }\n\n  /**\n   * Get enhancement purpose for custom addition\n   */\n  private getEnhancementPurpose(\n    addition: PremadeMode['customAdditions'][0],\n    targetFlavor: string\n  ): string {\n    const purposeMap: Record<string, Record<string, string>> = {\n      extract: {\n        'madagascar-vanilla-extract': 'Enhance vanilla authenticity and complexity',\n        'coffee-extract': 'Add deep coffee flavor without bitterness',\n        'caramel-extract': 'Intensify caramel notes and add warmth',\n        'hazelnut-extract': 'Add nutty complexity and richness'\n      },\n      oil: {\n        'orange-essential-oil': 'Provide bright citrus aroma and fresh notes',\n        'peppermint-oil': 'Add cooling sensation and fresh mint character'\n      },\n      concentrate: {\n        'fruit-puree-concentrate': 'Enhance natural fruit flavor and authenticity'\n      },\n      acid: {\n        'citric-acid': 'Brighten flavor and balance sweetness',\n        'fresh-lemon-juice': 'Add natural acidity and citrus brightness'\n      },\n      sweetener: {\n        'simple-syrub': 'Balance flavors and smooth harsh notes',\n        'honey-syrup': 'Add floral sweetness and complexity',\n        'brown-sugar-syrup': 'Enhance caramel notes and add richness'\n      }\n    };\n    \n    return purposeMap[addition.type]?.[addition.id] || `Enhance ${targetFlavor} profile`;\n  }\n\n  /**\n   * Get available quality enhancements\n   */\n  public getQualityEnhancements(): QualityEnhancement[] {\n    return [...this.qualityEnhancements];\n  }\n\n  /**\n   * Get layering strategies\n   */\n  public getLayeringStrategies(): Map<string, FlavorLayer[]> {\n    return new Map(this.layeringStrategies);\n  }\n\n  /**\n   * Analyze recipe compatibility\n   */\n  public analyzeCompatibility(\n    syrup: PremadeSyrup,\n    additions: PremadeMode['customAdditions']\n  ): {\n    compatibilityScore: number;\n    issues: string[];\n    recommendations: string[];\n  } {\n    let score = 50; // Base compatibility\n    const issues: string[] = [];\n    const recommendations: string[] = [];\n    \n    // Check for duplicate or conflicting additions\n    const additionTypes = additions.map(a => a.type);\n    const uniqueTypes = [...new Set(additionTypes)];\n    \n    if (uniqueTypes.length < additions.length) {\n      issues.push('Multiple additions of same type detected');\n      score -= 10;\n    }\n    \n    // Check syrup compatibility with additions\n    additions.forEach(addition => {\n      const enhancement = this.qualityEnhancements.find(\n        qe => qe.ingredient === addition.id\n      );\n      \n      if (enhancement) {\n        const isCompatible = enhancement.compatibleFlavors.some(flavor => \n          syrup.compatibleFlavors.includes(flavor)\n        );\n        \n        if (isCompatible) {\n          score += 15;\n        } else {\n          score -= 5;\n          issues.push(`Addition ${addition.id} may not complement ${syrup.name}`);\n        }\n      }\n    });\n    \n    // Provide recommendations\n    if (score < 70) {\n      recommendations.push('Consider reducing number of additions for better balance');\n      recommendations.push('Focus on additions that complement the syrup\\'s flavor profile');\n    }\n    \n    if (score > 85) {\n      recommendations.push('Excellent combination for high-quality results');\n      recommendations.push('Consider this as a signature recipe');\n    }\n    \n    return {\n      compatibilityScore: Math.max(0, Math.min(100, score)),\n      issues,\n      recommendations\n    };\n  }\n}"