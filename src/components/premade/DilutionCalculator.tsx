/**
 * DilutionCalculator Component
 * 
 * Visual dilution ratio tool with interactive controls for calculating\n * proper syrup-to-water ratios based on concentration and use case.\n * \n * @example\n * ```tsx\n * <DilutionCalculator\n *   syrup={selectedSyrup}\n *   targetVolume={250}\n *   useCase=\"coffee\"\n *   onDilutionCalculated={(result) => setDilutionResult(result)}\n * />\n * ```\n */\n\n'use client';\n\nimport React, { useState, useEffect, useMemo } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Slider } from '@/components/ui/slider';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Progress } from '@/components/ui/progress';\nimport { \n  Calculator, \n  Beaker, \n  Droplets, \n  Coffee, \n  Wine, \n  Ice, \n  Zap,\n  TrendingUp,\n  CheckCircle,\n  AlertTriangle,\n  Info,\n  RefreshCw\n} from 'lucide-react';\nimport { PremadeSyrup, DilutionGuide } from '@/lib/types';\nimport { DilutionGuideService } from '@/lib/dilution-guides';\n\n/**\n * DilutionCalculator Props\n */\ninterface DilutionCalculatorProps {\n  syrup: PremadeSyrup;\n  targetVolume?: number;\n  useCase?: 'coffee' | 'soda' | 'dessert' | 'beverage' | 'cocktail';\n  customRatio?: string;\n  onDilutionCalculated?: (result: DilutionCalculation) => void;\n  onRatioChange?: (ratio: string) => void;\n  className?: string;\n}\n\n/**\n * Dilution Calculation Result\n */\ninterface DilutionCalculation {\n  syrupAmount: number;\n  waterAmount: number;\n  totalVolume: number;\n  ratio: string;\n  concentration: 'very-light' | 'light' | 'medium' | 'strong' | 'very-strong';\n  recommendations: string[];\n  nutritionalInfo: {\n    calories: number;\n    sugar: number;\n    caffeine?: number;\n  };\n  tips: string[];\n}\n\n/**\n * Main DilutionCalculator Component\n */\nexport const DilutionCalculator: React.FC<DilutionCalculatorProps> = ({\n  syrup,\n  targetVolume = 250,\n  useCase = 'beverage',\n  customRatio,\n  onDilutionCalculated,\n  onRatioChange,\n  className = ''\n}) => {\n  const [volume, setVolume] = useState(targetVolume);\n  const [selectedRatio, setSelectedRatio] = useState(customRatio || '1:3');\n  const [calculatedResult, setCalculatedResult] = useState<DilutionCalculation | null>(null);\n  const [loading, setLoading] = useState(false);\n  const [activeTab, setActiveTab] = useState('calculator');\n  \n  // Initialize dilution service\n  const dilutionService = useMemo(() => new DilutionGuideService(), []);\n  \n  // Calculate dilution when inputs change\n  useEffect(() => {\n    const calculate = async () => {\n      setLoading(true);\n      try {\n        const result = calculateDilution(volume, selectedRatio, syrup, useCase);\n        setCalculatedResult(result);\n        onDilutionCalculated?.(result);\n      } catch (error) {\n        console.error('Failed to calculate dilution:', error);\n      } finally {\n        setLoading(false);\n      }\n    };\n    \n    calculate();\n  }, [volume, selectedRatio, syrup, useCase, dilutionService, onDilutionCalculated]);\n  \n  // Handle ratio change\n  const handleRatioChange = (ratio: string) => {\n    setSelectedRatio(ratio);\n    onRatioChange?.(ratio);\n  };\n  \n  // Get use case specific ratios\n  const useCaseRatios = {\n    coffee: [\n      { ratio: '1:2', label: 'Coffee Enhancement', strength: 'medium' },\n      { ratio: '1:3', label: 'Coffee Light', strength: 'light' },\n      { ratio: '1:1', label: 'Coffee Drizzle', strength: 'strong' }\n    ],\n    soda: [\n      { ratio: '1:6', label: 'Light & Refreshing', strength: 'very-light' },\n      { ratio: '1:4', label: 'Light Soda', strength: 'light' },\n      { ratio: '1:3', label: 'Classic Soda', strength: 'medium' },\n      { ratio: '1:2', label: 'Strong & Bold', strength: 'strong' }\n    ],\n    dessert: [\n      { ratio: '1:0.5', label: 'Concentrated Topping', strength: 'very-strong' },\n      { ratio: '1:1', label: 'Dessert Sweet', strength: 'medium' },\n      { ratio: '1:1.5', label: 'Light Dessert', strength: 'light' }\n    ],\n    beverage: [\n      { ratio: '1:8', label: 'Very Light', strength: 'very-light' },\n      { ratio: '1:6', label: 'Light Beverage', strength: 'light' },\n      { ratio: '1:3', label: 'Regular Beverage', strength: 'medium' },\n      { ratio: '1:2', label: 'Strong Beverage', strength: 'strong' }\n    ],\n    cocktail: [\n      { ratio: '1:1', label: 'Cocktail Base', strength: 'strong' },\n      { ratio: '1:2', label: 'Cocktail Light', strength: 'medium' },\n      { ratio: '1:3', label: 'Cocktail Long', strength: 'light' }\n    ]\n  };\n  \n  const currentRatios = useCaseRatios[useCase] || useCaseRatios.beverage;\n  \n  // Get dilution recommendations\n  const dilutionRecommendations = dilutionService.getDilutionRecommendations(syrup, useCase);\n  \n  return (\n    <div className={`space-y-6 ${className}`}>\n      {/* Header */}\n      <div className=\"flex items-center space-x-3\">\n        <div className=\"p-2 bg-blue-100 rounded-lg\">\n          <Calculator className=\"h-6 w-6 text-blue-600\" />\n        </div>\n        <div>\n          <h3 className=\"text-lg font-semibold text-gray-900\">\n            Dilution Calculator\n          </h3>\n          <p className=\"text-sm text-gray-600\">\n            Calculate perfect syrup-to-water ratios for {syrup.name}\n          </p>\n        </div>\n      </div>\n      \n      {/* Calculator Tabs */}\n      <Tabs value={activeTab} onValueChange={setActiveTab}>\n        <TabsList className=\"grid w-full grid-cols-3\">\n          <TabsTrigger value=\"calculator\" className=\"flex items-center space-x-2\">\n            <Beaker className=\"h-4 w-4\" />\n            <span>Calculator</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"recommendations\" className=\"flex items-center space-x-2\">\n            <Zap className=\"h-4 w-4\" />\n            <span>Recommendations</span>\n          </TabsTrigger>\n          <TabsTrigger value=\"guide\" className=\"flex items-center space-x-2\">\n            <Info className=\"h-4 w-4\" />\n            <span>Guide</span>\n          </TabsTrigger>\n        </TabsList>\n        \n        {/* Calculator Tab */}\n        <TabsContent value=\"calculator\" className=\"space-y-6\">\n          <div className=\"grid lg:grid-cols-2 gap-6\">\n            {/* Input Controls */}\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base\">Mixing Parameters</CardTitle>\n                <CardDescription>\n                  Adjust volume and dilution ratio\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-6\">\n                {/* Target Volume */}\n                <div>\n                  <Label htmlFor=\"volume\">Target Volume (ml)</Label>\n                  <div className=\"flex items-center space-x-4 mt-2\">\n                    <Input\n                      id=\"volume\"\n                      type=\"number\"\n                      value={volume}\n                      onChange={(e) => setVolume(parseInt(e.target.value) || 250)}\n                      min=\"50\"\n                      max=\"2000\"\n                      step=\"50\"\n                      className=\"flex-1\"\n                    />\n                    <div className=\"flex space-x-2\">\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\"\n                        onClick={() => setVolume(250)}\n                      >\n                        250ml\n                      </Button>\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\"\n                        onClick={() => setVolume(500)}\n                      >\n                        500ml\n                      </Button>\n                      <Button \n                        variant=\"outline\" \n                        size=\"sm\"\n                        onClick={() => setVolume(1000)}\n                      >\n                        1L\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n                \n                {/* Use Case Selection */}\n                <div>\n                  <Label>Use Case</Label>\n                  <Select value={useCase} disabled>\n                    <SelectTrigger>\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"coffee\">\n                        <div className=\"flex items-center space-x-2\">\n                          <Coffee className=\"h-4 w-4\" />\n                          <span>Coffee</span>\n                        </div>\n                      </SelectItem>\n                      <SelectItem value=\"soda\">\n                        <div className=\"flex items-center space-x-2\">\n                          <Droplets className=\"h-4 w-4\" />\n                          <span>Soda</span>\n                        </div>\n                      </SelectItem>\n                      <SelectItem value=\"dessert\">\n                        <div className=\"flex items-center space-x-2\">\n                          <Ice className=\"h-4 w-4\" />\n                          <span>Dessert</span>\n                        </div>\n                      </SelectItem>\n                      <SelectItem value=\"beverage\">\n                        <div className=\"flex items-center space-x-2\">\n                          <Beaker className=\"h-4 w-4\" />\n                          <span>Beverage</span>\n                        </div>\n                      </SelectItem>\n                      <SelectItem value=\"cocktail\">\n                        <div className=\"flex items-center space-x-2\">\n                          <Wine className=\"h-4 w-4\" />\n                          <span>Cocktail</span>\n                        </div>\n                      </SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                \n                {/* Ratio Selection */}\n                <div>\n                  <Label>Dilution Ratio</Label>\n                  <div className=\"grid grid-cols-2 gap-2 mt-2\">\n                    {currentRatios.map((ratioOption) => (\n                      <Button\n                        key={ratioOption.ratio}\n                        variant={selectedRatio === ratioOption.ratio ? \"default\" : \"outline\"}\n                        size=\"sm\"\n                        onClick={() => handleRatioChange(ratioOption.ratio)}\n                        className=\"justify-start\"\n                      >\n                        <div className=\"text-left\">\n                          <div className=\"font-medium\">{ratioOption.ratio}</div>\n                          <div className=\"text-xs text-gray-500\">{ratioOption.label}</div>\n                        </div>\n                      </Button>\n                    ))}\n                  </div>\n                </div>\n                \n                {/* Custom Ratio Input */}\n                <div>\n                  <Label htmlFor=\"custom-ratio\">Custom Ratio (syrup:water)</Label>\n                  <div className=\"flex items-center space-x-2 mt-2\">\n                    <Input\n                      id=\"custom-ratio\"\n                      placeholder=\"1:3\"\n                      value={selectedRatio}\n                      onChange={(e) => handleRatioChange(e.target.value)}\n                      pattern=\"\\\\d+:\\\\d+\"\n                    />\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\"\n                      onClick={() => setSelectedRatio(syrup.dilutionRatio)}\n                    >\n                      Default\n                    </Button>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n            \n            {/* Results Display */}\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-base\">Mixing Results</CardTitle>\n                <CardDescription>\n                  Calculated amounts and recommendations\n                </CardDescription>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                {loading ? (\n                  <div className=\"flex items-center justify-center py-8\">\n                    <RefreshCw className=\"h-6 w-6 animate-spin text-gray-400\" />\n                  </div>\n                ) : calculatedResult ? (\n                  <>\n                    {/* Visual Mixing Guide */}\n                    <div className=\"space-y-3\">\n                      <div className=\"text-sm font-medium text-gray-700 mb-3\">Mixing Guide</div>\n                      \n                      {/* Syrup Amount */}\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center justify-between\">\n                          <div className=\"flex items-center space-x-2\">\n                            <div className=\"w-3 h-3 bg-orange-500 rounded-full\"></div>\n                            <span className=\"text-sm font-medium\">Syrup</span>\n                          </div>\n                          <span className=\"text-sm font-bold text-orange-600\">\n                            {calculatedResult.syrupAmount.toFixed(1)}ml\n                          </span>\n                        </div>\n                        <Progress \n                          value={(calculatedResult.syrupAmount / volume) * 100}\n                          className=\"h-2\"\n                        />\n                      </div>\n                      \n                      {/* Water Amount */}\n                      <div className=\"space-y-2\">\n                        <div className=\"flex items-center justify-between\">\n                          <div className=\"flex items-center space-x-2\">\n                            <div className=\"w-3 h-3 bg-blue-500 rounded-full\"></div>\n                            <span className=\"text-sm font-medium\">Water</span>\n                          </div>\n                          <span className=\"text-sm font-bold text-blue-600\">\n                            {calculatedResult.waterAmount.toFixed(1)}ml\n                          </span>\n                        </div>\n                        <Progress \n                          value={(calculatedResult.waterAmount / volume) * 100}\n                          className=\"h-2\"\n                        />\n                      </div>\n                    </div>\n                    \n                    {/* Concentration Badge */}\n                    <div className=\"flex items-center justify-between\">\n                      <span className=\"text-sm font-medium text-gray-700\">Concentration</span>\n                      <Badge \n                        variant={getConcentrationVariant(calculatedResult.concentration)}\n                        className=\"capitalize\"\n                      >\n                        {calculatedResult.concentration.replace('-', ' ')}\n                      </Badge>\n                    </div>\n                    \n                    {/* Nutritional Info */}\n                    <div className=\"bg-gray-50 rounded-lg p-3 space-y-2\">\n                      <div className=\"text-sm font-medium text-gray-700\">Per Serving</div>\n                      <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                        <div>\n                          <span className=\"text-gray-600\">Calories:</span>\n                          <span className=\"ml-2 font-medium\">{calculatedResult.nutritionalInfo.calories}</span>\n                        </div>\n                        <div>\n                          <span className=\"text-gray-600\">Sugar:</span>\n                          <span className=\"ml-2 font-medium\">{calculatedResult.nutritionalInfo.sugar}g</span>\n                        </div>\n                        {calculatedResult.nutritionalInfo.caffeine && (\n                          <div className=\"col-span-2\">\n                            <span className=\"text-gray-600\">Caffeine:</span>\n                            <span className=\"ml-2 font-medium\">{calculatedResult.nutritionalInfo.caffeine}mg</span>\n                          </div>\n                        )}\n                      </div>\n                    </div>\n                    \n                    {/* Tips */}\n                    <div className=\"space-y-2\">\n                      <div className=\"text-sm font-medium text-gray-700\">Mixing Tips</div>\n                      <div className=\"space-y-1\">\n                        {calculatedResult.tips.map((tip, index) => (\n                          <div key={index} className=\"flex items-start space-x-2 text-sm text-gray-600\">\n                            <CheckCircle className=\"h-3 w-3 text-green-500 mt-0.5 flex-shrink-0\" />\n                            <span>{tip}</span>\n                          </div>\n                        ))}\n                      </div>\n                    </div>\n                  </>\n                ) : (\n                  <div className=\"text-center py-8\">\n                    <AlertTriangle className=\"h-8 w-8 text-gray-400 mx-auto mb-2\" />\n                    <p className=\"text-sm text-gray-600\">Enter valid parameters to calculate dilution</p>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </div>\n        </TabsContent>\n        \n        {/* Recommendations Tab */}\n        <TabsContent value=\"recommendations\" className=\"space-y-4\">\n          <div className=\"grid gap-4\">\n            {dilutionRecommendations.map((rec, index) => (\n              <Card key={index} className=\"cursor-pointer hover:shadow-md transition-shadow\">\n                <CardContent className=\"p-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center space-x-3\">\n                        <Badge variant=\"outline\" className=\"font-mono\">\n                          {rec.ratio}\n                        </Badge>\n                        <div>\n                          <h4 className=\"font-medium\">{rec.name}</h4>\n                          <p className=\"text-sm text-gray-600\">{rec.description}</p>\n                        </div>\n                      </div>\n                    </div>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\"\n                      onClick={() => handleRatioChange(rec.ratio)}\n                    >\n                      Use This\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            ))}\n          </div>\n        </TabsContent>\n        \n        {/* Guide Tab */}\n        <TabsContent value=\"guide\" className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"text-base\">Dilution Guide for {syrup.name}</CardTitle>\n              <CardDescription>\n                Best practices and recommendations for {syrup.brand} syrup\n              </CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-4\">\n              {/* Basic Instructions */}\n              <div className=\"space-y-3\">\n                <h4 className=\"font-medium text-gray-900\">Basic Instructions</h4>\n                <div className=\"space-y-2 text-sm text-gray-600\">\n                  <div className=\"flex items-start space-x-2\">\n                    <span className=\"flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold\">1</span>\n                    <span>Measure the required amount of syrup using the ratio above</span>\n                  </div>\n                  <div className=\"flex items-start space-x-2\">\n                    <span className=\"flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold\">2</span>\n                    <span>Add water to the mixing vessel (cold water for best results)</span>\n                  </div>\n                  <div className=\"flex items-start space-x-2\">\n                    <span className=\"flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold\">3</span>\n                    <span>Mix thoroughly for 30-60 seconds to ensure complete blending</span>\n                  </div>\n                  <div className=\"flex items-start space-x-2\">\n                    <span className=\"flex-shrink-0 w-6 h-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xs font-bold\">4</span>\n                    <span>Taste and adjust if necessary</span>\n                  </div>\n                </div>\n              </div>\n              \n              {/* Storage Tips */}\n              <div className=\"space-y-3\">\n                <h4 className=\"font-medium text-gray-900\">Storage & Usage</h4>\n                <div className=\"bg-blue-50 rounded-lg p-3 space-y-2 text-sm\">\n                  <div><strong>Storage:</strong> {syrup.usageGuide.storage}</div>\n                  <div><strong>Shelf Life:</strong> {syrup.usageGuide.shelfLife}</div>\n                  <div><strong>Max Daily:</strong> {syrup.usageGuide.maxDaily}ml</div>\n                </div>\n              </div>\n              \n              {/* Flavor Notes */}\n              <div className=\"space-y-3\">\n                <h4 className=\"font-medium text-gray-900\">Flavor Profile</h4>\n                <div className=\"flex flex-wrap gap-2\">\n                  {syrup.tasteProfile.notes.map((note, index) => (\n                    <Badge key={index} variant=\"secondary\" className=\"text-xs\">\n                      {note}\n                    </Badge>\n                  ))}\n                </div>\n                <div className=\"text-sm text-gray-600\">\n                  <strong>Sweetness:</strong> {syrup.tasteProfile.sweetness} â€¢ \n                  <strong className=\"ml-2\">Intensity:</strong> {syrup.tasteProfile.intensity}\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        </TabsContent>\n      </Tabs>\n    </div>\n  );\n};\n\n/**\n * Helper function to calculate dilution\n */\nfunction calculateDilution(\n  volume: number,\n  ratioStr: string,\n  syrup: PremadeSyrup,\n  useCase: string\n): DilutionCalculation {\n  // Parse ratio\n  const ratioMatch = ratioStr.match(/(\\d+)\\s*:\\s*(\\d+)/);\n  if (!ratioMatch) {\n    throw new Error('Invalid ratio format');\n  }\n  \n  const syrupPart = parseInt(ratioMatch[1]);\n  const waterPart = parseInt(ratioMatch[2]);\n  const totalParts = syrupPart + waterPart;\n  \n  const syrupAmount = (volume * syrupPart) / totalParts;\n  const waterAmount = (volume * waterPart) / totalParts;\n  \n  // Determine concentration\n  const concentrationRatio = waterPart / syrupPart;\n  let concentration: DilutionCalculation['concentration'];\n  \n  if (concentrationRatio >= 8) concentration = 'very-light';\n  else if (concentrationRatio >= 6) concentration = 'light';\n  else if (concentrationRatio >= 3) concentration = 'medium';\n  else if (concentrationRatio >= 2) concentration = 'strong';\n  else concentration = 'very-strong';\n  \n  // Calculate nutritional info (simplified)\n  const caloriesPerMl = 2; // Estimate\n  const sugarPerMl = 0.5; // Estimate\n  \n  const nutritionalInfo = {\n    calories: Math.round(syrupAmount * caloriesPerMl),\n    sugar: Math.round(syrupAmount * sugarPerMl * 10) / 10\n  };\n  \n  // Generate recommendations and tips\n  const recommendations = [\n    `${useCase.charAt(0).toUpperCase() + useCase.slice(1)} - ${ratioStr} ratio`,\n    `Total volume: ${volume}ml`,\n    `Perfect for ${useCase === 'coffee' ? 'coffee drinks' : useCase + ' applications'}`\n  ];\n  \n  const tips = [\n    'Use cold water for best taste',\n    'Mix thoroughly for 30-60 seconds',\n    'Taste and adjust sweetness as needed',\n    'Store in refrigerator if not consuming immediately'\n  ];\n  \n  return {\n    syrupAmount,\n    waterAmount,\n    totalVolume: volume,\n    ratio: ratioStr,\n    concentration,\n    recommendations,\n    nutritionalInfo,\n    tips\n  };\n}\n\n/**\n * Get concentration badge variant\n */\nfunction getConcentrationVariant(concentration: string): \"default\" | \"secondary\" | \"destructive\" | \"outline\" {\n  switch (concentration) {\n    case 'very-light':\n    case 'light':\n      return 'secondary';\n    case 'medium':\n      return 'default';\n    case 'strong':\n    case 'very-strong':\n      return 'destructive';\n    default:\n      return 'outline';\n  }\n}\n\nexport default DilutionCalculator;"