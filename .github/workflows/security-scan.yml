name: ğŸ”’ Security Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily security scans at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan to run'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - comprehensive
          - quick
          - dependencies
          - code_analysis

env:
  NODE_VERSION: '18'
  SECURITY_THRESHOLD_CRITICAL: 0
  SECURITY_THRESHOLD_HIGH: 5
  SECURITY_THRESHOLD_MEDIUM: 20

jobs:
  security-scan:
    name: ğŸ” Security Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      security-score: ${{ steps.security-report.outputs.security-score }}
      critical-issues: ${{ steps.security-report.outputs.critical-issues }}
      high-issues: ${{ steps.security-report.outputs.high-issues }}
      medium-issues: ${{ steps.security-report.outputs.medium-issues }}
      scan-status: ${{ steps.security-scan-status.outputs.status }}
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
          
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --silent
          npm run security:install
          
      - name: ğŸ” Run Comprehensive Security Scan
        id: security-scan
        run: |
          echo "ğŸ”’ Starting comprehensive security analysis..."
          
          # Run the existing security scanner
          npm run security:scan || true
          
          # Run npm audit with fail mode for CI
          echo "ğŸ“Š Running npm audit..."
          npm audit --audit-level=moderate || true
          
          # Run ESLint security checks
          echo "ğŸ§¹ Running ESLint security scan..."
          npm run lint -- --format=json --output-file=security-lint-results.json || true
          
          # Generate security report
          echo "ğŸ“‹ Generating security report..."
          npm run security:report || true
          
          echo "âœ… Security scan completed"
          
      - name: ğŸ” Advanced Dependency Scanning
        run: |
          echo "ğŸ” Running advanced dependency analysis..."
          
          # Install additional security tools
          npm install --save-dev @snyk/cli audit-ci
          
          # Run Snyk if configured
          if [ -n "${{ secrets.SNYK_TOKEN }}" ]; then
            echo "ğŸ›¡ï¸ Running Snyk scan..."
            npx snyk test --json --file=package.json || true
            npx snyk monitor --json --file=package.json || true
          fi
          
          # Run audit-ci for additional dependency scanning
          echo "ğŸ” Running audit-ci scan..."
          npx audit-ci --config audit-ci.json || true
          
      - name: ğŸ” Secret Scanning
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified
          
      - name: ğŸ” CodeQL Security Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript
          queries: security-extended,security-and-quality
          
      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript,typescript"
          
      - name: ğŸ“Š Security Score Calculation
        id: security-report
        run: |
          echo "ğŸ“Š Calculating security metrics..."
          
          # Parse security scan results
          if [ -f "security-scan-results.json" ]; then
            CRITICAL=$(jq -r '.summary.critical // 0' security-scan-results.json)
            HIGH=$(jq -r '.summary.high // 0' security-scan-results.json)
            MEDIUM=$(jq -r '.summary.medium // 0' security-scan-results.json)
            LOW=$(jq -r '.summary.low // 0' security-scan-results.json)
            SCORE=$(jq -r '.score // 0' security-scan-results.json)
          else
            CRITICAL=0
            HIGH=0
            MEDIUM=0
            LOW=0
            SCORE=0
          fi
          
          echo "critical-issues=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high-issues=$HIGH" >> $GITHUB_OUTPUT
          echo "medium-issues=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low-issues=$LOW" >> $GITHUB_OUTPUT
          echo "security-score=$SCORE" >> $GITHUB_OUTPUT
          
          echo "ğŸ”’ Security Score: $SCORE/100"
          echo "ğŸ”´ Critical Issues: $CRITICAL"
          echo "ğŸŸ  High Issues: $HIGH"
          echo "ğŸŸ¡ Medium Issues: $MEDIUM"
          echo "ğŸ”µ Low Issues: $LOW"
          
      - name: ğŸš¦ Security Gate Evaluation
        id: security-scan-status
        run: |
          CRITICAL=${{ steps.security-report.outputs.critical-issues }}
          HIGH=${{ steps.security-report.outputs.high-issues }}
          MEDIUM=${{ steps.security-report.outputs.medium-issues }}
          SCORE=${{ steps.security-report.outputs.security-score }}
          
          if [ "$CRITICAL" -gt "${{ env.SECURITY_THRESHOLD_CRITICAL }}" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ SECURITY SCAN FAILED: $CRITICAL critical issues found (threshold: ${{ env.SECURITY_THRESHOLD_CRITICAL }})"
            exit 1
          elif [ "$HIGH" -gt "${{ env.SECURITY_THRESHOLD_HIGH }}" ]; then
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "âŒ SECURITY SCAN FAILED: $HIGH high severity issues found (threshold: ${{ env.SECURITY_THRESHOLD_HIGH }})"
            exit 1
          elif [ "$SCORE" -lt "70" ]; then
            echo "status=warning" >> $GITHUB_OUTPUT
            echo "âš ï¸ SECURITY SCORE LOW: $SCORE/100 (minimum: 70)"
          else
            echo "status=passed" >> $GITHUB_OUTPUT
            echo "âœ… Security scan passed"
          fi
          
      - name: ğŸ“‹ Security Report Upload
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-results
          path: |
            security-scan-results.json
            security-lint-results.json
            audit-ci.json
            snyk-*
          retention-days: 30
          
      - name: ğŸ“Š Security Dashboard Comment
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            
            let comment = `## ğŸ”’ Security Scan Results
            
            **Security Score**: ${{ steps.security-report.outputs.security-score }}/100
            - ğŸ”´ Critical: ${{ steps.security-report.outputs.critical-issues }}
            - ğŸŸ  High: ${{ steps.security-report.outputs.high-issues }}
            - ğŸŸ¡ Medium: ${{ steps.security-report.outputs.medium-issues }}
            - ğŸ”µ Low: ${{ steps.security-report.outputs.low-issues }}
            
            **Scan Status**: ${{ steps.security-scan-status.outputs.status }}
            
            `;
            
            const critical = parseInt('${{ steps.security-report.outputs.critical-issues }}');
            const high = parseInt('${{ steps.security-report.outputs.high-issues }}');
            
            if (critical > 0 || high > 5) {
              comment += `\n> âš ï¸ **Security issues detected**. Please address critical and high severity issues before merging.\n`;
            } else {
              comment += `\n> âœ… Security scan passed. Ready for review.\n`;
            }
            
            comment += `\nğŸ“‹ [View detailed security report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  dependency-review:
    name: ğŸ” Dependency Security Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ” Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          comment-summary-in-pr: always
          allow-ghsas: |
            GHSA-xxxx-xxxx-xxxx

  container-security:
    name: ğŸ³ Container Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ” Build Docker Image
        run: |
          docker build -t energy-drink-app:${{ github.sha }} .
          
      - name: ğŸ”’ Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'energy-drink-app:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: ğŸ“¤ Upload Trivy Scan Results to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  security-notifications:
    name: ğŸ“¢ Security Notifications
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-review, container-security]
    if: always() && (needs.security-scan.result == 'failure' || needs.dependency-review.result == 'failure')
    
    steps:
      - name: ğŸ“¢ Security Alert Notification
        uses: actions/github-script@v7
        with:
          script: |
            const message = `ğŸš¨ **Security Alert** ğŸš¨
            
            Security scan failed for commit \`${{ github.sha }}\` on branch \`${{ github.ref_name }}\`.
            
            **Issues Found:**
            - Critical: ${{ needs.security-scan.outputs.critical-issues || 0 }}
            - High: ${{ needs.security-scan.outputs.high-issues || 0 }}
            
            **Action Required:**
            - Review security scan results
            - Fix critical and high severity issues
            - Re-run security scan
            
            [View Security Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            @security-team @dev-team`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Security Scan Failed - ${process.env.GITHUB_REF_NAME || 'Unknown Branch'}`,
              body: message,
              labels: ['security', 'urgent', 'bug']
            });
            
      - name: ğŸ“§ Send Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          channel: '#security'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          message: |
            ğŸš¨ Security scan failed for ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Critical Issues: ${{ needs.security-scan.outputs.critical-issues || 0 }}
            High Issues: ${{ needs.security-scan.outputs.high-issues || 0 }}
            
            [View Report](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}